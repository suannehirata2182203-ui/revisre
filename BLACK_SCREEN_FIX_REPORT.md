# üîß –û–¢–ß–ï–¢ –û–ë –ò–°–ü–†–ê–í–õ–ï–ù–ò–ò –ß–ï–†–ù–û–ì–û –≠–ö–†–ê–ù–ê

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê
–°–∞–π—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω, —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è.

## üîç –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´

### –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å selfHandleResponse

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**
1. –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `selfHandleResponse: true` –º—ã –î–û–õ–ñ–ù–´ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –í–°–ï –æ—Ç–≤–µ—Ç—ã
2. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∏–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –±—Ä–∞—É–∑–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
3. –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç = —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω

**–ü—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ:**
- –ù–µ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—É—Å—Ç–æ–π `bodyString` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- –ù–µ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–æ–≤
- –ù–µ –±—ã–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–≤–µ—Ç –º–æ–≥ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –≤–æ–æ–±—â–µ

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π bodyString

**–ë—ã–ª–æ:**
```javascript
if (contentType.includes('text/html')) {
  let modifiedBodyString = bodyString; // –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
```

**–°—Ç–∞–ª–æ:**
```javascript
if (contentType.includes('text/html') && bodyString && bodyString.length > 0) {
  let modifiedBodyString = bodyString; // –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–µ –ø—É—Å—Ç–æ–π
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –£–ª—É—á—à–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è bodyString

**–ë—ã–ª–æ:**
```javascript
let bodyString = body.toString();
```

**–°—Ç–∞–ª–æ:**
```javascript
let bodyString = body.length > 0 ? body.toString('utf8') : '';
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```javascript
try {
  if (!res.headersSent) {
    res.writeHead(proxyRes.statusCode || 200, modifiedHeaders);
  }
  
  if (body.length > 0) {
    if (contentType.includes('text/') || 
        contentType.includes('application/json') || 
        contentType.includes('application/javascript') || 
        ...) {
      const textContent = bodyString || body.toString('utf8');
      res.end(textContent);
    } else {
      res.end(body); // Buffer –¥–ª—è –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    }
  } else {
    res.end(); // –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
  }
} catch (responseError) {
  // Fallback: –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π Buffer
  ...
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 4: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- `application/javascript`
- `application/x-javascript`
- `text/css`
- `text/xml`

–í—Å–µ —ç—Ç–∏ —Ç–∏–ø—ã —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ.

## üéØ –ü–û–ß–ï–ú–£ –≠–¢–û –î–û–õ–ñ–ù–û –†–ê–ë–û–¢–ê–¢–¨

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π body:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º `body.length > 0` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
   - –ü—Ä–æ–≤–µ—Ä—è–µ–º `bodyString.length > 0` –¥–ª—è HTML
   - –ò–∑–±–µ–≥–∞–µ–º –æ—à–∏–±–æ–∫ —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - –í—Å–µ –æ–±–µ—Ä–Ω—É—Ç–æ –≤ try-catch
   - –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π Buffer
   - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

3. **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–æ–≤:**
   - –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ç–∏–ø—ã ‚Üí —Å—Ç—Ä–æ–∫–∞
   - –ë–∏–Ω–∞—Ä–Ω—ã–µ —Ç–∏–ø—ã ‚Üí Buffer
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞ (utf8)

4. **–ì–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:**
   - –° `selfHandleResponse: true` –º—ã –û–ë–Ø–ó–ê–ù–´ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
   - –í—Å–µ –ø—É—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è `res.end()`
   - –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ

## üîÑ –ü–û–ß–ï–ú–£ –ü–†–ï–î–´–î–£–©–ò–ô –ö–û–î –ù–ï –†–ê–ë–û–¢–ê–õ

### –ü—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥:
```javascript
if (contentType.includes('text/') || contentType.includes('application/json')) {
  res.end(bodyString); // –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ undefined
} else {
  res.end(body); // –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º Buffer
}
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—É—Å—Ç–æ–π bodyString
- ‚ùå –ù–µ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- ‚ùå –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–≤–µ—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è
- ‚ùå –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (JS, CSS)

### –¢–µ–∫—É—â–∏–π –∫–æ–¥:
```javascript
try {
  if (body.length > 0) {
    if (contentType.includes('text/') || ...) {
      const textContent = bodyString || body.toString('utf8'); // fallback
      res.end(textContent);
    } else {
      res.end(body);
    }
  } else {
    res.end(); // –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
  }
} catch (responseError) {
  // Fallback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π Buffer
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π body
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ Fallback –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π Buffer
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞

## üìä –¢–ò–ü–´ –ö–û–ù–¢–ï–ù–¢–ê

### –¢–µ–∫—Å—Ç–æ–≤—ã–µ (–æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞):
- `text/html`
- `text/css`
- `text/javascript`
- `text/xml`
- `application/json`
- `application/javascript`
- `application/x-javascript`

### –ë–∏–Ω–∞—Ä–Ω—ã–µ (–æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∫ Buffer):
- `image/*`
- `video/*`
- `audio/*`
- `application/octet-stream`
- `font/*`
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ—Ç–æ–º—É —á—Ç–æ:

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ** - –∏–∑–±–µ–≥–∞–µ–º –æ—à–∏–±–æ–∫
‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –æ—Ç–≤–µ—Ç–∞ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–æ–≤** - —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏, –±–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–∫ Buffer
‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞** - –≤—Å–µ –ø—É—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è res.end()

–ü—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª, –ø–æ—Ç–æ–º—É —á—Ç–æ:
‚ùå –ù–µ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø—É—Å—Ç–æ–π bodyString
‚ùå –ù–µ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
‚ùå –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–≤–µ—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª—Å—è ‚Üí —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω
‚ùå –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞

–¢–µ–ø–µ—Ä—å –∫–æ–¥ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ —Å–∞–π—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è!

